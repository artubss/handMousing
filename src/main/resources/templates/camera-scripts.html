<!-- Scripts da P√°gina da C√¢mera -->
<div th:fragment="scripts">
  <script>
    let cameraActive = false;
    let cameraStream = null;
    let videoElement = null;
    let calibrationActive = false;
    let calibrationPoints = 0;
    let sessionId = null;

    function startCamera() {
      if (cameraActive) {
        console.log("C√¢mera j√° est√° ativa");
        return;
      }

      const constraints = {
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          frameRate: { ideal: 30 },
        },
      };

      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(function (stream) {
          cameraStream = stream;
          cameraActive = true;

          // Cria elemento de v√≠deo
          const cameraFeed = document.getElementById("cameraFeed");
          cameraFeed.innerHTML =
            '<video id="cameraVideo" autoplay muted style="max-width: 100%; height: auto;"></video>';

          videoElement = document.getElementById("cameraVideo");
          videoElement.srcObject = stream;

          updateCameraStatus("Ativo");
          updateCameraInfo();

          // Inicia detec√ß√£o de m√£os
          startHandDetection();

          console.log("‚úÖ C√¢mera iniciada com sucesso");
        })
        .catch(function (error) {
          console.error("‚ùå Erro ao iniciar c√¢mera:", error);
          updateCameraStatus("Erro: " + error.message);
        });
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach((track) => track.stop());
        cameraStream = null;
        cameraActive = false;

        const cameraFeed = document.getElementById("cameraFeed");
        cameraFeed.innerHTML =
          '<i class="fas fa-video fa-3x text-light"></i><p class="text-light mt-2">Feed da c√¢mera ser√° exibido aqui</p>';

        updateCameraStatus("Parado");
        console.log("üõë C√¢mera parada");
      }
    }

    function captureFrame() {
      if (!cameraActive || !videoElement) {
        alert("C√¢mera n√£o est√° ativa");
        return;
      }

      const canvas = document.createElement("canvas");
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(videoElement, 0, 0);

      // Cria link para download
      const link = document.createElement("a");
      link.download = "capture_" + new Date().getTime() + ".png";
      link.href = canvas.toDataURL();
      link.click();

      console.log("üì∏ Frame capturado");
    }

    // Fun√ß√µes de calibra√ß√£o
    function startCalibration() {
      if (!cameraActive) {
        alert("C√¢mera deve estar ativa para calibrar");
        return;
      }

      sessionId = "camera_" + Date.now();
      calibrationActive = true;
      calibrationPoints = 0;

      fetch("/api/calibration/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: `sessionId=${sessionId}`,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            updateCalibrationStatus("Calibrando...");
            updateCalibrationPoints("0/4");
            showNotification("Calibra√ß√£o iniciada", "success");
          } else {
            showNotification("Erro ao iniciar calibra√ß√£o", "error");
          }
        })
        .catch((error) => {
          console.error("Erro:", error);
          showNotification("Erro ao iniciar calibra√ß√£o", "error");
        });
    }

    function autoCalibrate() {
      if (!cameraActive) {
        alert("C√¢mera deve estar ativa para calibrar");
        return;
      }

      sessionId = "camera_" + Date.now();

      fetch("/api/calibration/auto", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: `sessionId=${sessionId}`,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            updateCalibrationStatus("Calibrado");
            updateCalibrationPoints("4/4");
            updateCalibrationAccuracy("100%");
            showNotification("Calibra√ß√£o autom√°tica conclu√≠da", "success");
          } else {
            showNotification("Erro na calibra√ß√£o autom√°tica", "error");
          }
        })
        .catch((error) => {
          console.error("Erro:", error);
          showNotification("Erro na calibra√ß√£o autom√°tica", "error");
        });
    }

    function resetCalibration() {
      fetch("/api/calibration/reset", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            updateCalibrationStatus("N√£o calibrado");
            updateCalibrationPoints("0/4");
            updateCalibrationAccuracy("--");
            showNotification("Calibra√ß√£o resetada", "success");
          } else {
            showNotification("Erro ao resetar calibra√ß√£o", "error");
          }
        })
        .catch((error) => {
          console.error("Erro:", error);
          showNotification("Erro ao resetar calibra√ß√£o", "error");
        });
    }

    // Fun√ß√µes de detec√ß√£o de m√£os
    function startHandDetection() {
      fetch("/api/detection/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            console.log("‚úÖ Detec√ß√£o de m√£os iniciada");
          } else {
            console.error("‚ùå Erro ao iniciar detec√ß√£o:", data.error);
          }
        })
        .catch((error) => {
          console.error("‚ùå Erro ao iniciar detec√ß√£o:", error);
        });
    }

    function updateCameraStatus(status) {
      document.getElementById("cameraStatus").textContent = status;
    }

    function updateCameraInfo() {
      if (videoElement) {
        document.getElementById("currentResolution").textContent =
          videoElement.videoWidth + "x" + videoElement.videoHeight;
      }
    }

    function updateCalibrationStatus(status) {
      document.getElementById("calibrationStatus").textContent = status;
    }

    function updateCalibrationPoints(points) {
      document.getElementById("calibrationPoints").textContent = points;
    }

    function updateCalibrationAccuracy(accuracy) {
      document.getElementById("calibrationAccuracy").textContent = accuracy;
    }

    function showNotification(message, type) {
      const notification = document.createElement("div");
      notification.className = `alert alert-${
        type === "success" ? "success" : "danger"
      } alert-dismissible fade show position-fixed`;
      notification.style.cssText =
        "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
      notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

      document.body.appendChild(notification);

      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Atualiza informa√ß√µes de detec√ß√£o
    function updateDetectionInfo() {
      fetch("/api/detection/status")
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            document.getElementById("handCount").textContent =
              data.handCount || 0;
            const confidence = Math.round((data.confidence || 0) * 100);
            document.getElementById("confidence").textContent =
              confidence + "%";
          }
        })
        .catch((error) => {
          console.error("Erro ao obter status da detec√ß√£o:", error);
        });
    }

    // Event listeners para controles
    document
      .getElementById("resolutionSelect")
      .addEventListener("change", function () {
        if (cameraActive) {
          stopCamera();
          setTimeout(startCamera, 100);
        }
      });

    document
      .getElementById("fpsSelect")
      .addEventListener("change", function () {
        if (cameraActive) {
          stopCamera();
          setTimeout(startCamera, 100);
        }
      });

    // Atualiza informa√ß√µes periodicamente
    setInterval(function () {
      if (cameraActive) {
        updateCameraInfo();
        updateDetectionInfo();
      }
    }, 1000);

    // Inicializa√ß√£o
    document.addEventListener("DOMContentLoaded", function () {
      console.log("üìπ P√°gina da c√¢mera carregada");
      updateCameraStatus("Desconectado");
    });
  </script>
</div>
